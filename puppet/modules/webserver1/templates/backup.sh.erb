#!/bin/sh
##################
# Puppet managed #
##################

DOMAIN=$1

u_sure() {
  echo "Launching a backup of $DOMAIN to $SERVER ..."
}

rsync_local_files() {
  rsync -a /var/www/$DOMAIN/conf /var/www/$DOMAIN/cgi-bin /var/www/$DOMAIN/backups/
  if [ "$1" = "true" ]; then
    rsync -a /var/lib/awstats/awstats??????.www.$DOMAIN.??? /var/www/$DOMAIN/backups/awstats/
  else
    rsync -a /var/lib/awstats/awstats??????.$DOMAIN.??? /var/www/$DOMAIN/backups/awstats/
  fi
}

case "$DOMAIN" in
<% webserver_domains.each do |k,v| -%>
<% next unless v.has_key? 'web_backups_server' -%>
  <%= v['name'] %>)
    SERVER=<%= v['web_backups_server'] %>
    USER=<%= "backups_" if v['user_ftp'] == v['name'] %><%= v['name'] %>
    u_sure
    rsync_local_files <%= v['awstats_www'] %>
<% if v['database'] != "" -%>
    SQLBAK=/var/www/$DOMAIN/backups/$DOMAIN.sql
    <%= "/usr/bin/mysqldump -u #{v['user_mysql']} -p#{v['password_db']} #{v['database']} > $SQLBAK ; gzip -f $SQLBAK ; chmod 600 $SQLBAK.gz" %>
<% end -%>
    <%= "/usr/local/sbin/backup.rb $DOMAIN $SERVER #{v['web_backups_server_port']||22} #{v['history']||7} \"#{v['excludes']}\" $USER" %>
    ;;
<% end -%>
  *)
    echo "Usage: backup domain.name"
    exit 1
esac

exit 0
